<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wuyi.mall.mapper.ProductMapper">

    <!-- 查询商品库存 -->
    <select id="selectStockById" resultType="java.lang.Integer">
        SELECT stock_num FROM product WHERE id = #{id}
    </select>

    <!-- 查询商品列表 -->
    <select id="selectByIds" resultType="com.wuyi.mall.entity.Product">
        SELECT * FROM product WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <!-- 扣减商品库存（乐观锁） -->
    <update id="decreaseStock">
        UPDATE product
        SET stock_num = stock_num - #{quantity},
            version = version + 1
        WHERE id = #{id}
          AND stock_num &gt;= #{quantity}
          AND version = #{version}
    </update>

    <!-- 恢复商品库存（乐观锁） -->
    <update id="increaseStock">
        UPDATE product
        SET stock_num = stock_num + #{quantity},
            version = version + 1
        WHERE id = #{id}
          AND version = #{version}
    </update>

    <!-- 更新商品评分和评价数量 -->
    <update id="updateCommentStats">
        UPDATE product
        SET average_score = #{averageScore},
            comment_count = #{commentCount}
        WHERE id = #{id}
    </update>

    <!-- 更新商品价格 -->
    <update id="updatePrice">
        UPDATE product
        SET current_price = #{newPrice},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 检查商品是否属于指定商家 -->
    <select id="checkProductBelongsToShop" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM product WHERE id = #{productId} AND shop_id = #{shopId}
    </select>

    <!-- 查询商品的当前价格 -->
    <select id="selectCurrentPriceById" resultType="java.math.BigDecimal">
        SELECT current_price FROM product WHERE id = #{id}
    </select>

    <!-- 查询商品的所属店铺ID -->
    <select id="selectShopIdByProductId" resultType="java.lang.Long">
        SELECT shop_id FROM product WHERE id = #{id}
    </select>

</mapper>